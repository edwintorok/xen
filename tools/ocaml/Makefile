XEN_ROOT = $(CURDIR)/../..
include $(XEN_ROOT)/tools/Rules.mk

SUBDIRS := libs
SUBDIRS += xenstored

ifeq ($(CONFIG_TESTS),y)
SUBDIRS += test
endif

.NOTPARALLEL:
# targets here must be run in order, otherwise we can try
# to build programs before the libraries are done

.PHONY: all
all: subdirs-all

.PHONY: install
install: subdirs-install

.PHONY: uninstall
uninstall: subdirs-uninstall

.PHONY: clean
clean: subdirs-clean

.PHONY: distclean
distclean: subdirs-distclean

.PHONY: build-tools-oxenstored
build-tools-oxenstored:
	$(MAKE) -s -C libs/eventchn
	$(MAKE) -s -C libs/mmap
	$(MAKE) -s -C libs/xb
	$(MAKE) -s -C libs/xc
	$(MAKE) -C xenstored


include Makefile.generated
# Files generated by the Makefile
# These cannot be generated from dune, because dune cannot refer to files
# in the parent directory (so it couldn't copy/use Config.mk)
.PHONY: root-build-tools-public-headers dune-pre
root-build-tools-public-headers: $(XEN_ROOT)/config/Tools.mk
	$(MAKE) -s -C $(XEN_ROOT) build-tools-public-headers V=

.PHONY: generated-files
dune-pre: root-build-tools-public-headers generated-files

.PHONY: check
check: dune-pre
	# --force isn't necessary here if the test is deterministic
	dune runtest --profile=release --no-buffer

# Convenience targets for development

.PHONY: dune-clean
dune-clean:
	$(MAKE) clean
	dune clean

.PHONY: dune-syntax-check
dune-syntax-check: dune-pre
	dune build @check

.PHONY: build-oxenstored-dune
dune-build-oxenstored: dune-pre
	dune build --profile=release @install

.PHONY: dune-prepare

NPROC=$(shell getconf _NPROCESSORS_ONLN)
dune-prepare:
	test -f $(XEN_ROOT)/config/Tools.mk || (cd $(XEN_ROOT) && ./configure)
	$(MAKE) -C ../libs -O -j$(NPROC)
	$(MAKE) clean V= -j$(NPROC)
	$(MAKE) dune-pre -j$(NPROC)

dune-help:
	@echo "Available targets:"
	@echo "	dune-prepare: configure Xen in a minimal way to be able to build the C libraries used by oxenstored"
	@echo "	dune-clean: clean build directory for both regular and Dune builds"
	@echo "	dune-syntax-check: runs 'dune build @check' after having generated files with 'make dune-pre'"
	@echo "	dune-build-oxenstored: runs 'dune build --profile=relase @install' after having generated files with 'make dune-pre'"
