XEN_ROOT = $(CURDIR)/../..
include $(XEN_ROOT)/tools/Rules.mk

SUBDIRS := libs
SUBDIRS += xenstored

ifeq ($(CONFIG_TESTS),y)
SUBDIRS += test
endif

.NOTPARALLEL:
# targets here must be run in order, otherwise we can try
# to build programs before the libraries are done

.PHONY: all
all: subdirs-all

.PHONY: install
install: subdirs-install

.PHONY: uninstall
uninstall: subdirs-uninstall

.PHONY: clean
clean: subdirs-clean

.PHONY: distclean
distclean: subdirs-distclean

.PHONY: build-tools-oxenstored
build-tools-oxenstored:
	$(MAKE) -s -C libs/eventchn
	$(MAKE) -s -C libs/mmap
	$(MAKE) -s -C libs/xb
	$(MAKE) -s -C libs/xc
	$(MAKE) -C xenstored

LIBRARY_PATH=$(XEN_libxenctrl):$(XEN_libxenguest):$(XEN_libxentoollog):$(XEN_libxencall):$(XEN_libxenevtchn):$(XEN_libxenforeignmemory):$(XEN_libxengnttab):$(XEN_libxendevicemodel):$(XEN_libxentoolcore)
C_INCLUDE_PATH=$(XEN_libxenctrl)/include:$(XEN_libxengnttab)/include:$(XEN_libxenevtchn)/include:$(XEN_libxentoollog)/include:$(XEN_INCLUDE)

# Files generated by the Makefile
# These cannot be generated from dune, because dune cannot refer to files
# in the parent directory (so it couldn't copy/use Config.mk)
.PHONY: dune-pre
dune-pre:
	$(MAKE) -s -C ../../ build-tools-public-headers
	$(MAKE) -s -C libs/xs paths.ml
	$(MAKE) -s -C libs/xc xenctrl_abi_check.h
	$(MAKE) -s -C xenstored paths.ml

.PHONY: check
check: dune-pre
	# --force isn't necessary here if the test is deterministic
	OCAMLRUNPARAM=b C_INCLUDE_PATH=$(C_INCLUDE_PATH) dune runtest --profile=release --no-buffer --force

check2: dune-pre
	OCAMLRUNPARAM=b C_INCLUDE_PATH=$(C_INCLUDE_PATH) dune build @check --profile=release

ortac1: dune-pre
	OCAMLRUNPARAM=b C_INCLUDE_PATH=$(C_INCLUDE_PATH) dune exec --profile=release ./xsgen_monolith.exe --no-buffer

input:
	dd if=/dev/urandom of=$@ bs=1M count=1

mono-fuzz1: dune-pre input
	OCAMLRUNPARAM=b C_INCLUDE_PATH=$(C_INCLUDE_PATH) dune exec --profile=release libs/xb/test/memory_size_monolith.exe --no-buffer input

ortac-fuzz1: dune-pre
	OCAMLRUNPARAM=b C_INCLUDE_PATH=$(C_INCLUDE_PATH) dune build --profile=release @ortac-fuzz1 --no-buffer

ortac-fuzz: dune-pre
	OCAMLRUNPARAM=b C_INCLUDE_PATH=$(C_INCLUDE_PATH) dune build --profile=release @ortac-fuzz --no-buffer

event-print: dune-pre
	OCAMLRUNPARAM=b C_INCLUDE_PATH=$(C_INCLUDE_PATH) dune exec ocaml-print-intf xenstored/event.ml

check3: dune-pre
	OCAMLRUNPARAM=b C_INCLUDE_PATH=$(C_INCLUDE_PATH) dune build @gospel-check @check --profile=release

check4: dune-pre
	OCAMLRUNPARAM=b C_INCLUDE_PATH=$(C_INCLUDE_PATH) dune build @check @cameleer-check --profile=release

# Convenience targets for development

.PHONY: dune-clean
dune-clean:
	$(MAKE) clean
	dune clean

.PHONY: dune-syntax-check
dune-syntax-check: dune-pre
	LIBRARY_PATH=$(LIBRARY_PATH) C_INCLUDE_PATH=$(C_INCLUDE_PATH) dune build --profile=release @check

.PHONY: build-oxenstored-dune
dune-build-oxenstored: dune-pre
	LD_LIBRARY_PATH=$(LIBRARY_PATH) LIBRARY_PATH=$(LIBRARY_PATH) C_INCLUDE_PATH=$(C_INCLUDE_PATH) dune build --profile=release @all
