XEN_ROOT = $(CURDIR)/../..
include $(XEN_ROOT)/tools/Rules.mk

SUBDIRS := libs
SUBDIRS += xenstored

ifeq ($(CONFIG_TESTS),y)
SUBDIRS += test
endif

.NOTPARALLEL:
# targets here must be run in order, otherwise we can try
# to build programs before the libraries are done

.PHONY: all
all: subdirs-all

.PHONY: install
install: subdirs-install

.PHONY: uninstall
uninstall: subdirs-uninstall

.PHONY: clean
clean: subdirs-clean

.PHONY: distclean
distclean: subdirs-distclean

.PHONY: build-tools-oxenstored
build-tools-oxenstored:
	$(MAKE) -s -C libs/eventchn
	$(MAKE) -s -C libs/mmap
	$(MAKE) -s -C libs/xb
	$(MAKE) -s -C libs/xc
	$(MAKE) -C xenstored

LIBRARY_PATH=$(XEN_libxenctrl)
LIBRARY_PATH:=$(LIBRARY_PATH):$(XEN_libxenguest)
LIBRARY_PATH:=$(LIBRARY_PATH):$(XEN_libxentoollog)
LIBRARY_PATH:=$(LIBRARY_PATH):$(XEN_libxencall)
LIBRARY_PATH:=$(LIBRARY_PATH):$(XEN_libxenevtchn)
LIBRARY_PATH:=$(LIBRARY_PATH):$(XEN_libxenforeignmemory)
LIBRARY_PATH:=$(LIBRARY_PATH):$(XEN_libxengnttab)
LIBRARY_PATH:=$(LIBRARY_PATH):$(XEN_libxendevicemodel)
LIBRARY_PATH:=$(LIBRARY_PATH):$(XEN_libxentoolcore)
C_INCLUDE_PATH=$(XEN_libxenctrl)/include
C_INCLUDE_PATH:=$(C_INCLUDE_PATH):$(XEN_libxengnttab)/include
C_INCLUDE_PATH:=$(C_INCLUDE_PATH):$(XEN_libxenevtchn)/include
C_INCLUDE_PATH:=$(C_INCLUDE_PATH):$(XEN_libxentoollog)/include
C_INCLUDE_PATH:=$(C_INCLUDE_PATH):$(XEN_INCLUDE)

# Files generated by the Makefile
# These cannot be generated from dune, because dune cannot refer to files
# in the parent directory (so it couldn't copy/use Config.mk)
.PHONY: dune-pre
dune-pre:
	$(MAKE) -s -C ../../ build-tools-public-headers
	$(MAKE) -s -C libs/xs paths.ml
	$(MAKE) -s -C libs/xc xenctrl_abi_check.h
	$(MAKE) -s -C xenstored paths.ml _paths.h

.PHONY: check
check: dune-pre
	# --force isn't necessary here if the test is deterministic
	OCAMLRUNPARAM=b C_INCLUDE_PATH=$(C_INCLUDE_PATH) dune runtest --profile=release --no-buffer --force

# Convenience targets for development

.PHONY: dune-clean
dune-clean:
	$(MAKE) clean
	dune clean

.PHONY: dune-syntax-check
dune-syntax-check: dune-pre
	LIBRARY_PATH=$(LIBRARY_PATH) C_INCLUDE_PATH=$(C_INCLUDE_PATH) dune build --profile=release @check

.PHONY: build-oxenstored-dune
dune-build-oxenstored: dune-pre
	LD_LIBRARY_PATH=$(LIBRARY_PATH) LIBRARY_PATH=$(LIBRARY_PATH) C_INCLUDE_PATH=$(C_INCLUDE_PATH) dune build --profile=release @all
