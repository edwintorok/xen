; fallback mode: the files may have been generated by configure already
; also for fallback mode either all files must be present or none
; hence the 2 separate rules here

(rule
 (targets oxenstored.conf)
 (deps oxenstored.conf.in)
 (mode fallback)
 (action
  (run ../../config.status --file=oxenstored.conf)))

(rule
 (targets paths.ml)
 (deps paths.ml.in)
 (mode fallback)
 (action
  (run ../../config.status --file=paths.ml)))

(executable
 (modes native)
 (name xenstored)
 (modules
  (:standard \ syslog))
 (flags
  (:standard -w -52))
 (libraries unix xen.bus xen.mmap xen.ctrl xen.eventchn xenstubs))

(install
 (package xenstored)
 (section sbin)
 (files
  (xenstored.exe as oxenstored)))

(install
 (package xen)
 (section etc)
 (files oxenstored.conf))

(library
 (foreign_stubs
  (language c)
  (names syslog_stubs select_stubs)
  (extra_deps ../../dune-workspace)
  (flags
   (:standard -DHAVE_SYSTEMD)))
 (modules syslog)
 (name xenstubs)
 (wrapped false)
 (libraries unix)
 (no_dynlink))
